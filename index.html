<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Text Explainer (Client-Side w/ LocalStorage Key)</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .controls, .content-area, .explanation-area {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h1, h2, h3 {
            color: #333;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="password"], select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            display: inline-block;
            background: #5cb85c;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #4cae4c;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #generatedTextOutput {
            background-color: #e9e9e9;
            padding: 15px;
            border-radius: 4px;
            min-height: 100px;
            white-space: pre-wrap; /* Preserve line breaks */
        }
        .selectable-text::selection {
            background-color: #b3d4fc;
        }
        #selectedTextDisplay {
            font-style: italic;
            color: #007bff;
        }
        #explanationOutput p, #translationOutput p,
        #explanationOutput .translation-list, #translationOutput .translation-list {
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 3px;
            margin-top: 5px;
        }
        .translation-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 5px;
        }
        .translation-list li {
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            line-height: 1.5;
        }
        .translation-list li:last-child {
            border-bottom: none;
        }
        .translation-nuance {
            font-size: 0.9em;
            color: #555;
            margin-left: 5px;
            font-style: italic;
        }
        .api-key-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom:15px;
        }
        .api-key-controls input {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .api-key-controls button {
            padding: 10px; /* Make save button same height as input */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Text Generator & Explainer (Client-Side w/ LocalStorage Key)</h1>
        <p style="color: red; font-weight: bold;">WARNING: This demo uses localStorage for the API key. For personal, local use ONLY. DO NOT HOST PUBLICLY.</p>

        <div class="controls">
            <label for="apiKey">GEMINI API Key:</label>
            <div class="api-key-controls">
                <input type="password" id="apiKey" placeholder="Enter your Gemini API Key here">
                <button id="saveApiKeyBtn">Save Key</button>
                <button id="clearApiKeyBtn" style="background-color: #d9534f;">Clear Key</button>
            </div>
            <small>Key is saved in your browser's localStorage for this page. Click "Save Key" after entering/changing.</small>
            <hr>
            <label for="topic">Topic:</label>
            <input type="text" id="topic" value="the future of space travel">

            <label for="difficulty">Difficulty:</label>
            <select id="difficulty">
                <option value="easy">Easy (A2)</option>
                <option value="medium" selected>Medium (B1/B2)</option>
                <option value="hard">Hard (C1/C2)</option>
            </select>

            <label for="length">Length:</label>
            <select id="length">
                <option value="one sentence">One Sentence</option>
                <option value="a short paragraph" selected>Short Paragraph</option>
                <option value="two paragraphs">Two Paragraphs</option>
            </select>

            <button id="generateBtn">Generate Text</button>
        </div>

        <div class="content-area">
            <h2>Generated Text:</h2>
            <div id="generatedTextOutput" class="selectable-text">
                <p>Your generated text will appear here...</p>
            </div>
        </div>

        <div class="explanation-area">
            <h2>Selection Details:</h2>
            <p><strong>Selected:</strong> <em id="selectedTextDisplay">-</em></p>
            
            <label for="translateLang">Translate to:</label>
            <select id="translateLang">
                <option value="Spanish">Spanish</option>
                <option value="French">French</option>
                <option value="German">German</option>
                <option value="Ukrainian">Ukrainian</option>
                <option value="Russian">Russian</option>
                <option value="Japanese">Japanese</option>
                <option value="Chinese">Chinese</option>
            </select>
            <button id="getDetailsBtn" disabled>Get Explanation & Translation</button>

            <div id="explanationOutput">
                <h3>Explanation:</h3>
                <p>Select text above to get its explanation.</p>
            </div>
            <div id="translationOutput">
                <h3>Translation:</h3>
                <p>Select text and choose a language to get its translation.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GEMINI_MODEL = "gemini-1.5-flash-latest";
            const API_KEY_STORAGE_NAME = "geminiApiKey_aiTextExplainer";

            const apiKeyInput = document.getElementById('apiKey');
            const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
            const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
            const generateBtn = document.getElementById('generateBtn');
            const topicInput = document.getElementById('topic');
            const difficultySelect = document.getElementById('difficulty');
            const lengthSelect = document.getElementById('length');
            const generatedTextOutput = document.getElementById('generatedTextOutput');
            const selectedTextDisplay = document.getElementById('selectedTextDisplay');
            const getDetailsBtn = document.getElementById('getDetailsBtn');
            const translateLangSelect = document.getElementById('translateLang');
            const explanationOutputDiv = document.getElementById('explanationOutput');
            const translationOutputDiv = document.getElementById('translationOutput');
            
            let currentSelectedText = "";

            // --- API Key Management with localStorage ---
            function loadApiKey() {
                const storedKey = localStorage.getItem(API_KEY_STORAGE_NAME);
                if (storedKey) {
                    apiKeyInput.value = storedKey;
                    console.log("API Key loaded from localStorage.");
                } else {
                    console.log("No API Key found in localStorage.");
                }
            }

            function saveApiKey() {
                const keyToSave = apiKeyInput.value.trim();
                if (keyToSave) {
                    localStorage.setItem(API_KEY_STORAGE_NAME, keyToSave);
                    alert("API Key saved to browser's localStorage for this page.");
                } else {
                    alert("API Key field is empty. Nothing saved.");
                }
            }
            
            function clearApiKey() {
                localStorage.removeItem(API_KEY_STORAGE_NAME);
                apiKeyInput.value = "";
                alert("API Key cleared from localStorage and input field.");
            }

            saveApiKeyBtn.addEventListener('click', saveApiKey);
            clearApiKeyBtn.addEventListener('click', clearApiKey);
            
            // Load API key when the page loads
            loadApiKey();


            // --- Helper Functions ---
            function getApiKeyFromInput() { // Renamed to avoid conflict
                const key = apiKeyInput.value.trim();
                if (!key) {
                    alert("CRITICAL: Gemini API Key is missing. Please enter it and click 'Save Key'.");
                    throw new Error("API Key missing from input.");
                }
                return key;
            }

            function sanitizeTextForHTML(text) {
                if (typeof text !== 'string') text = String(text);
                const temp = document.createElement('div');
                temp.textContent = text;
                return temp.innerHTML;
            }

            function formatForDisplay(text) {
                return sanitizeTextForHTML(text).replace(/\n/g, '<br>');
            }

            async function callGeminiAPI(promptText) {
                let currentApiKey;
                try {
                    currentApiKey = getApiKeyFromInput();
                } catch (e) {
                    return `Error: ${e.message}`;
                }

                const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${currentApiKey}`;
                const payload = { contents: [{ parts: [{ text: promptText }] }] };

                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const responseData = await response.json();
                    if (!response.ok) {
                        const errorDetail = responseData.error?.message || `HTTP error! Status: ${response.status}`;
                        console.error("Gemini API Error Response:", responseData);
                        throw new Error(errorDetail);
                    }
                    if (responseData.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return responseData.candidates[0].content.parts[0].text.trim();
                    } else if (responseData.promptFeedback?.blockReason) {
                        return `Blocked by API: ${responseData.promptFeedback.blockReason}. Details: ${JSON.stringify(responseData.promptFeedback.safetyRatings || {})}`;
                    } else {
                        console.error("Unexpected Gemini API response structure:", responseData);
                        return "Error: Could not parse text from Gemini API response.";
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    return `Error: ${error.message}`;
                }
            }

            function getDifficultyPromptText(difficulty) {
                if (difficulty === "easy") return "Use simple vocabulary and sentence structures...";
                if (difficulty === "medium") return "Use moderately complex vocabulary...";
                if (difficulty === "hard") return "Use advanced vocabulary...";
                return "";
            }

            // --- Event Listeners (Generate, Select, Get Details) ---
            generateBtn.addEventListener('click', async () => {
                try { getApiKeyFromInput(); } catch (e) { generatedTextOutput.innerHTML = `<p style="color: red;">${formatForDisplay(e.message)}</p>`; return; }
                const topic = topicInput.value.trim();
                if (!topic) { generatedTextOutput.innerHTML = `<p style="color: orange;">Please enter a topic.</p>`; return; }

                generatedTextOutput.innerHTML = '<p>Generating...</p>';
                // ... (rest of UI reset logic) ...
                selectedTextDisplay.textContent = "-";
                explanationOutputDiv.innerHTML = '<h3>Explanation:</h3><p>Select text...</p>';
                translationOutputDiv.innerHTML = '<h3>Translation:</h3><p>Select text...</p>';
                getDetailsBtn.disabled = true;


                const difficultyInstruction = getDifficultyPromptText(difficultySelect.value);
                const prompt = `${difficultyInstruction} Generate text about ${lengthSelect.value} long on the topic: ${topic}`;
                const generatedText = await callGeminiAPI(prompt);

                if (generatedText.startsWith("Error:") || generatedText.startsWith("Blocked by API:")) {
                    generatedTextOutput.innerHTML = `<p style="color: red;">${formatForDisplay(generatedText)}</p>`;
                } else {
                    generatedTextOutput.innerHTML = `<p>${formatForDisplay(generatedText)}</p>`;
                }
            });

            document.addEventListener('mouseup', () => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                if (generatedTextOutput.contains(selection.anchorNode) && generatedTextOutput.contains(selection.focusNode)) {
                    if (selectedText.length > 0) {
                        currentSelectedText = selectedText;
                        selectedTextDisplay.innerHTML = `"${sanitizeTextForHTML(currentSelectedText)}"`;
                        getDetailsBtn.disabled = false;
                        // ... (UI update for explanation/translation placeholders) ...
                    }
                }
            });

            getDetailsBtn.addEventListener('click', async () => {
                if (!currentSelectedText) return;
                try { getApiKeyFromInput(); } catch (e) { /* ... error display ... */ return; }

                explanationOutputDiv.innerHTML = '<h3>Explanation:</h3><p>Fetching explanation...</p>';
                translationOutputDiv.innerHTML = '<h3>Translation:</h3><p>Fetching translation...</p>';
                getDetailsBtn.disabled = true;

                const targetLanguage = translateLangSelect.value;
                const fullContextText = generatedTextOutput.querySelector('p')?.textContent || "";

                let explanationPromptParts = ["Explain the following word or phrase clearly..."];
                if (fullContextText) { /* ... add context ... */ }
                explanationPromptParts.push(`The specific word/phrase to explain is: "${currentSelectedText}"...`);
                const explanationPrompt = explanationPromptParts.join(" ");
                const explanationResult = await callGeminiAPI(explanationPrompt);
                // ... (display explanationResult) ...
                if (explanationResult.startsWith("Error:") || explanationResult.startsWith("Blocked by API:")) {
                    explanationOutputDiv.innerHTML = `<h3>Explanation:</h3><p style="color: red;">Explanation failed: ${formatForDisplay(explanationResult)}</p>`;
                } else {
                    explanationOutputDiv.innerHTML = `<h3>Explanation:</h3><p>${formatForDisplay(explanationResult)}</p>`;
                }


                const translationPrompt = ( /* ... your detailed translation prompt ... */
                    `Provide a list of the most common and direct translations in ${targetLanguage} ` +
                    `for the English word/phrase: "${currentSelectedText}". ` +
                    `Avoid introductory sentences. Just the list.`
                );
                const translationResult = await callGeminiAPI(translationPrompt);
                const translationHTML = generateTranslationListHTML(translationResult, targetLanguage);
                translationOutputDiv.innerHTML = `<h3>Translation (to ${sanitizeTextForHTML(targetLanguage)}):</h3>${translationHTML}`;
                
                getDetailsBtn.disabled = false;
            });

            function generateTranslationListHTML(rawTranslation, targetLanguage) {
                // ... (same implementation as before) ...
                let cleanedLines = rawTranslation.split('\n').map(line => {
                    line = line.trim();
                    line = line.replace(/^\s*[\*\-]\s*(\*\*.*?\*\*|\*.*?\*|)/, '');
                    line = line.replace(/^\s*(\*\*.*?\*\*|\*.*?\*)/, '$1');
                    const metaCommentaryPatterns = [ /* ... patterns ... */ ];
                    if (metaCommentaryPatterns.some(pattern => pattern.test(line))) return "";
                    return line.trim();
                }).filter(line => line.length > 0);

                if (cleanedLines.length === 0) return `<p>${formatForDisplay(rawTranslation || "No translation available.")}</p>`;
                // ... (rest of list generation) ...
                 let listHTML = '<ul class="translation-list">';
                cleanedLines.forEach(line => {
                    let displayLine = sanitizeTextForHTML(line);
                    displayLine = displayLine.replace(/(\(.*?\))/g, '<span class="translation-nuance">$1</span>');
                    listHTML += `<li>${displayLine}</li>`;
                });
                listHTML += '</ul>';
                return listHTML;
            }
            
        }); // End DOMContentLoaded
    </script>
</body>
</html>